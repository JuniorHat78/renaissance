Renaissance Plan
Date: 2026-02-18
Status: Implemented roadmap with actionables complete and verified.

Objective (This Phase)
- Keep search discoverable and shareable without overcrowding reading pages.
- Shift heavy search exploration to a dedicated full-results page.

Current Priority (Visual Recovery)
- Reset the recent over-styled search UI pass to a cleaner baseline.
- Re-polish search UI deliberately using screenshot loops (not blind CSS iteration).
- Keep all search behavior and URL contracts unchanged during this visual pass.

Locked Product Decisions
- Search surfaces remain:
  - Home global search.
  - Essay local search.
- Inline search becomes preview-only (not full comb-through UI).
- Full comb-through moves to dedicated `search.html`.
- Deep-linking and sharing are first-class:
  - `q` + `occ` result links.
  - text highlight links.
  - Chromium text fragments with fallback.

Execution Plan
1. Shared Search Engine Foundation
- Keep one shared client-side search engine module.
- Reuse content loaders and searchable text parsing.
- Preserve match modes and sorting logic.
- Keep lazy index build + in-memory caching.

2. Inline Preview Search (Home + Essay)
- Home: compact global search in header.
- Essay: compact local search in upper-right.
- Results are grouped by section.
- Show section-level counts + first N hits per section (default N = 3).
- Add `View Full Results` CTA carrying current query/options.

3. Dedicated Full Results Page (`search.html`)
- Add full search route for comb-through workflows.
- Support:
  - global scope or essay scope
  - advanced controls
  - full pagination (`Previous` / `Next`)
  - page size 25/50/100 (default 50)
- Preserve URL state for refresh/share.

4. Shareable Deep Links (Search to Reader)
- Result links include `q` and `occ`:
  - `section.html?essay=<slug>&section=<n>&q=<term>&occ=<k>`
- On load:
  - resolve k-th occurrence
  - scroll to hit
  - apply visible highlight

5. Shareable Manual Highlights
- Add selection action: `Copy Link to Highlight`.
- Generate two link variants:
  - Chromium: `#:~:text=...`
  - Fallback: query params (`hl`, optional context)
- Reader resolves fallback highlight reliably after load.

6. Anchor Priority Rules
- If multiple anchor modes exist in URL, resolve in order:
  1) explicit highlight (`hl` / text-fragment fallback data)
  2) occurrence (`occ`)
  3) plain query (`q`) with no anchor target

7. UI Polish Pass
- Improve select/dropdown styling to match theme.
- Fix checkbox alignment for case-sensitive toggle.
- Tighten control spacing and visual hierarchy.
- Keep controls subtle and non-dashboard-like.

8. QA and Hardening
- Validate inline preview grouping + preview limit behavior.
- Validate full page pagination and URL round-trip.
- Validate `occ` deep-links and highlight placement.
- Validate Chromium text-fragment behavior and non-Chromium fallback.
- Validate mobile/desktop layout and keyboard accessibility.
- Validate localhost and embedded fallback runtime modes.

9. Contextual Highlight Sharing UX
- Reduce friction for in-section sharing in long reads.
- Desktop:
  - Show a floating `Copy highlight link` chip near active text selection.
  - Position chip with viewport clamping.
- Mobile:
  - Show a fixed bottom mini action bar when selection is active.
- Keep top `Copy Link to Highlight` button as fallback for accessibility and degraded scenarios.
- Preserve existing link format:
  - Chromium text fragment (`#:~:text=...`)
  - fallback params (`hl`, optional `hlp`/`hls`)
- Interaction rules:
  - Hide contextual action on collapsed/outside selection, `Esc`, or after copy success timeout.
  - Do not override native browser context menus.
- QA additions:
  - Validate mid-section selection workflows in long sections.
  - Validate desktop/mobile behavior, light/dark themes, and keyboard fallback path.

10. Short Source-Link Strategy
- Reduce copied source URL length while preserving deterministic re-open behavior.
- Selection-to-link anchor strategy:
  - Full paragraph selection(s) -> `p=<start>-<end>` paragraph range anchors.
  - Partial contiguous selection -> `r=<start>-<end>` compact absolute offsets (base36).
  - Fallback for unsupported/ambiguous cases -> existing `hl` payload anchors.
- Prefer compact anchors over long text payload in source links.
- Keep backward compatibility for existing `hl` links.
- Build source link base by runtime:
  - `http/https` uses current origin.
  - `file://` falls back to canonical public URL when available.
- Clipboard behavior:
  - copied quote remains unchanged
  - append `[Source] <url>` with compact anchor when available.

11. Screenshot-Driven Reset + Re-Polish Workflow (Current)
- Runtime source of truth:
  - Use the running local server at `http://127.0.0.1:8000` (user-managed).
- Visual evidence source:
  - Use browser PNG screenshots from real viewport rendering.
  - Do not use PDF snapshots for layout/style decisions.
- Required capture set per iteration:
  - Desktop: `1440x1200`
  - Mobile: `390x844`
  - Pages:
    - `index.html`
    - `essay.html?essay=etching-god-into-sand`
    - `search.html?q=sand`
- Iteration sequence:
  1) Capture current-state screenshots.
  2) Reset search UI styling to pre-overstyled baseline (UI only).
  3) Capture reset baseline screenshots.
  4) Apply subtle polish pass A (control sizing, alignment, spacing).
  5) Capture screenshots and review.
  6) Apply subtle polish pass B (advanced panel and dropdown polish, restrained).
  7) Capture screenshots and review.
  8) Apply subtle polish pass C (results/pagination integration, restrained).
  9) Final screenshot capture and QA sign-off.
- Guardrails for this pass:
  - No search logic changes.
  - No URL/state changes.
  - No copy/deep-link behavior changes.
  - Keep visual language book-like and understated (avoid dashboard/chip-heavy styling).

12. Visual QA Tooling Architecture (Codified Next Step)
- Goal:
  - Make UI screenshot review repeatable, comparable, and CI-friendly.
- Runtime:
  - Local dev server remains user-managed at `http://127.0.0.1:8000`.
- Components:
  1) Scenario Registry
  - File: `qa/visual/scenarios.json`
  - Contains deterministic capture scenarios:
    - route
    - viewport/device
    - theme
    - query-state
    - scroll behavior (top/bottom/full)
  2) Capture Runner
  - File: `scripts/visual/capture.js`
  - Reads scenario registry and captures PNGs.
  - Writes to:
    - `qa/visual/current/`
  3) Diff Runner
  - File: `scripts/visual/diff.js`
  - Compares:
    - `qa/visual/current/` vs `qa/visual/baseline/`
  - Writes:
    - `qa/visual/diff/`
    - `qa/visual/report.json`
    - `qa/visual/report.md`
  4) Approve Runner
  - File: `scripts/visual/approve.js`
  - Promotes current images to baseline when changes are intentional.
  5) NPM Entrypoints
  - `visual:capture`
  - `visual:diff`
  - `visual:check` (capture + diff)
  - `visual:approve`
- Stability Constraints:
  - Fixed viewport sizes
  - Fixed locale/timezone
  - Fixed browser channel
  - Prefer reduced-motion for stable snapshots
- CI Strategy:
  - Start with warning mode (non-blocking)
  - Upload `current/diff/report` artifacts for PR review
  - Optionally promote to strict blocking mode later

13. Recommendations Actionables (Codified Backlog)
- R1 `copy-footer-format`:
  - Standardize source footer copy format across copy surfaces.
  - Priority: Medium
  - Status: Done
- R2 `q-only-cap-note`:
  - Show subtle note when `q`-only highlight cap is applied.
  - Priority: Medium
  - Status: Done
- R3 `anchor-regression-suite`:
  - Add focused automated checks for anchor/occurrence precedence and highlight counts.
  - Priority: High
  - Status: Done
- R4 `highlight-perf-metric`:
  - Add lightweight dev-only timing metric for multi-highlight passes.
  - Priority: Low
  - Status: Done
- R5 `visual-qa-routine`:
  - Make screenshot diff checks part of normal pre-merge workflow.
  - Priority: High
  - Status: Done

Deliverables
- Preview-first inline search on home and essay pages.
- New `search.html` full-results workflow.
- Shareable search and highlight links (Chromium + fallback).
- Contextual (selection-driven) highlight-share UX on section reader.
- Refined search control styling and alignment.
- Screenshot workflow script and reproducible screenshot output folders for review loops.
- Codified visual QA architecture (`scenario -> capture -> diff -> approve`) for implementation.
- Actionable recommendation backlog with priorities and statuses.
- Updated QA checklist and acceptance verification.

Out of Scope (This Phase)
- Backend indexing service.
- Search analytics dashboard.
- Vector/semantic retrieval.
- Cross-essay compare workspace.
- Any content or narrative edits to essays.
